<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atbuilt ‚Äì Sistema de Gest√£o de Postes</title>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- html2canvas + jsPDF bundle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Certifique-se de ter inclu√≠do o jsPDF (bundle) em seu HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <!-- CSS Externo (ou inline) -->
  <link rel="stylesheet" href="estilos.css" />
  <style>
    /* ================== Estilos Gerais ================== */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    h2 { margin-bottom: 16px; }

    /* ===== Tela de Login ===== */
    .login-container {
      display: flex; align-items: center; justify-content: center;
      height: 100vh;
    }
    .login-box {
      border: 1px solid #ccc; padding: 20px; border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .login-box input {
      width: 250px; margin-bottom: 10px; padding: 8px; font-size: 14px;
    }
    .login-box button {
      padding: 8px 12px; font-size: 14px; background: #1976d2;
      color: #fff; border: none; border-radius: 4px; cursor: pointer;
    }
    .login-box button:hover { background: #155a9e; }
    .login-erro { margin-top: 8px; color: red; font-size: 13px; }

    /* ===== Sistema ap√≥s login ===== */
    .sistema-container { display: none; padding: 20px; }
    .header {
      background: #f5f5f5; border-radius: 8px; padding: 12px; margin-bottom: 16px;
      display: flex; gap: 12px; flex-wrap: wrap;
    }
    .header div { display: flex; flex-direction: column; }
    .header label { font-weight: bold; font-size: 14px; margin-bottom: 4px; }
    .header input, .header select {
      padding: 6px 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px;
      width: 180px;
    }

    .acoes {
      margin-bottom: 12px;
    }
    .acoes button {
      margin-right: 8px; padding: 8px 12px; background: #1e88e5;
      color: #fff; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;
    }
    .acoes button:hover { background: #1565c0; }

    #contadorStatus { margin-bottom: 12px; font-weight: bold; }
    #paginacao button { margin: 0 4px; padding: 4px 8px; font-size: 14px; }

    .scroll-table {
      max-height: 400px; overflow-y: auto; border: 1px solid #ddd;
      margin-bottom: 16px;
    }
    #tabelaPostes {
      width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;
    }
    #tabelaPostes th, #tabelaPostes td {
      padding: 8px; border: 1px solid #ccc; font-size: 14px; white-space: nowrap;
    }
    #tabelaPostes th {
      background: #00695c; color: #fff; position: sticky; top: 0; z-index: 1;
    }
    .miniatura {
      width: 50px; height: 50px; object-fit: cover; border-radius: 4px;
      border: 1px solid #ccc;
    }
    button.delete-btn {
      background: transparent; border: none; font-size: 16px; color: #c62828; cursor: pointer;
    }
    button.delete-btn:hover { color: #b71c1c; }

    /* ========== Estilos de impress√£o (PDF) ========== */
    @media print {
      body { margin: 0; padding: 0; }
      #pdfContainer { width: 210mm; margin: 0 auto; }
      .acoes, .header input, .header select, #map, .mapa-container, #paginacao {
        display: none !important;
      }
      .scroll-table { max-height: none; }
      #tabelaPostes { width: 100%; table-layout: fixed; }
      #tabelaPostes th, #tabelaPostes td { word-wrap: break-word; }
    }
  </style>
</head>

<body>
  <!-- ===== Tela de Login ===== -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h2>Login</h2>
      <input type="text" id="loginEmail" placeholder="E-mail ou Usu√°rio" />
      <input type="password" id="loginSenha" placeholder="Senha" />
      <button onclick="fazerLogin()">Entrar</button>
      <div id="loginErro" class="login-erro"></div>
      <div style="margin-top:30px; text-align:center;">
        <img src="logo-atbuilt.png" alt="Logo" style="height:50px; margin-bottom:8px;" />
        <h3 style="font-size:16px; color:#1a202c;">Atbuilt ‚Äì Sistema de Gest√£o</h3>
      </div>
    </div>
  </div>

  <!-- ===== Sistema (ap√≥s login) ===== -->
  <div id="sistemaContainer" class="sistema-container">
    <div id="mainContent" class="container">
      <!-- In√≠cio do conte√∫do capturado pelo PDF -->
      <div id="pdfContainer">
        <h2>Atbuilt ‚Äì Sistema de Gest√£o de Postes</h2>

        <!-- Filtros -->
        <div class="header">
          <div>
            <label for="usuario">E-mail do usu√°rio</label>
            <input type="text" id="usuario" oninput="filtrarPostes()" placeholder="Filtrar por usu√°rio" />
          </div>
          <div>
            <label for="filtroProjeto">ID do Projeto</label>
            <select id="filtroProjeto" onchange="filtrarPostes()">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label for="filtroPoste">C√≥digo do Poste</label>
            <input type="text" id="filtroPoste" oninput="filtrarPostes()" placeholder="Filtrar por c√≥digo" />
          </div>
          <div>
            <label for="filtroStatus">Status</label>
            <select id="filtroStatus" onchange="filtrarPostes()">
              <option value="">Todos</option>
              <option value="em andamento">Em andamento</option>
              <option value="conclu√≠do">Conclu√≠do</option>
            </select>
          </div>
          <div>
            <label for="dataInicial">De:</label>
            <input type="date" id="dataInicial" onchange="filtrarPostes()" />
          </div>
          <div>
            <label for="dataFinal">At√©:</label>
            <input type="date" id="dataFinal" onchange="filtrarPostes()" />
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="acoes">
          <button onclick="exportarCSV(false)">üì• Baixar P√°gina</button>
          <button onclick="exportarCSV(true)">üì• Baixar Tudo</button>
          <button onclick="baixarPDFModelo()">üìÑ Baixar PDF</button>
          <button id="btnPowerBI" onclick="togglePowerBI()">üìä Power BI</button>
          <button id="btnMostrarPodas" onclick="togglePodas()">üåø Mostrar Podas</button>
          <button id="btnMostrarLinhaViva" onclick="toggleLinhaViva()">‚ö° Mostrar Linha Viva</button>
        </div>

        <!-- Contador de Status -->
        <div id="contadorStatus"></div>

        <!-- Pagina√ß√£o -->
        <div id="paginacao"></div>

        <!-- Tabela de Postes -->
        <div class="scroll-table">
          <table id="tabelaPostes">
            <thead>
              <tr>
                <th>Data</th>
                <th>ID Projeto</th>
                <th>PG</th>
                <th>Poste Prim√°rio</th>
                <th>Estrut. Prim√°ria</th>
                <th>Poste Secund√°rio</th>
                <th>Estrut. Secund√°ria</th>
                <th>Linha Viva</th>
                <th>Servi√ßos Podas</th>
                <th>Observa√ß√µes</th>
                <th>Foto1</th>
                <th>Foto2</th>
                <th>Foto3</th>
                <th>Lat</th>
                <th>Lng</th>
                <th>Usu√°rio</th>
                <th>Status</th>
                <th>A√ß√µes</th>
                <th>Excluir</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
<!-- Mapa dos Postes -->
<!-- Mapa dos Postes -->
<h3 class="map-title">üìç Mapa dos Postes</h3>

<!-- Farol de status (amarelo = em andamento, vermelho = pendente) -->
<div style="display: flex; gap: 16px; margin-bottom: 8px; align-items: center;">
  <div style="display: flex; align-items: center;">
    <span style="
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: #ffc107; /* amarelo */
      border-radius: 50%;
      margin-right: 6px;
      box-shadow: 0 0 1px rgba(0,0,0,0.2);
    "></span>
    Em andamento
  </div>
  <div style="display: flex; align-items: center;">
    <span style="
      display: inline-block;
      width: 12px;
      height: 12px;
      background-color: #dc3545; /* vermelho */
      border-radius: 50%;
      margin-right: 6px;
      box-shadow: 0 0 1px rgba(0,0,0,0.2);
    "></span>
    Concluido
  </div>
</div>

<div id="map" class="mapa-container" style="height:400px; margin-top:12px;"></div>
<!-- Fim do conte√∫do capturado -->



      <!-- Container Power BI (invis√≠vel at√© clicar) -->
      <div id="powerbiContainer" style="display:none; margin:16px 0; position:relative;">
        <button onclick="togglePowerBI()" style="position:absolute; top:0; right:0;">‚Üê Voltar ao Painel</button>
        <iframe
          title="Atbuilt Power BI"
          width="600"
          height="373.5"
          src="https://app.powerbi.com/view?r=eyJrIjoiOWRiZTkzYTItZTAxNC00YzU3LWI2MWMtMDBiOWM0OTAxZjgxIiwidCI6ImMyNGEyNGRjLWJjYTAtNGYyYS1hOTRmLWY3NDVkNDdkZTE4MCJ9"
          frameborder="0"
          allowfullscreen>
        </iframe>
      </div>
    </div>
  </div>

  <!-- initMap para Google Maps -->
  <script>
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -8.0, lng: -35.0 },
        zoom: 6,
        gestureHandling: "greedy",
        zoomControl: true,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: true,
      });
    }
  </script>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDP1sgTUcHF3ULf9ezZNRbjj2RN-2uNtRQ&callback=initMap"
    async defer>
  </script>
  <script src="https://cdn.jsdelivr.net/npm/google-maps-utility-library-v3-infobox@latest/infobox.min.js"></script>

  <!-- L√≥gica Firebase + Tabela + Filtros + Mapa + Exporta√ß√£o + PDF -->
  <script>
    // ---------- Inicializa√ß√£o Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyC_z3mtM3e5stpmRU_XLT2JfBw9jjF9rXY",
      authDomain: "atbuilt-7dd80.firebaseapp.com",
      databaseURL: "https://atbuilt-7dd80-default-rtdb.firebaseio.com",
      projectId: "atbuilt-7dd80",
      storageBucket: "atbuilt-7dd80-firebasestorage.app",
      messagingSenderId: "123721475775",
      appId: "1:123721475775:android:9e77fabafc90364feb480a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let todosOsPostes = [];
    let listaVisivel = [];
    let paginaAtual = 1;
    const itensPorPagina = 100;
    let map;
    let markers = [];
    let mostrandoSomentePodas = false;
    let mostrandoSomenteLinhaViva = false;

    // ---------- Fun√ß√£o de Login ----------
    function fazerLogin() {
      const email = document.getElementById("loginEmail").value.trim();
      const senha = document.getElementById("loginSenha").value.trim();
      if (!email || !senha) {
        document.getElementById("loginErro").innerText = "Por favor, preencha e-mail e senha.";
        return;
      }
      auth.signInWithEmailAndPassword(email, senha)
        .then(() => {
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("sistemaContainer").style.display = "block";
          carregarPostes();
        })
        .catch(err => {
          document.getElementById("loginErro").innerText = `Erro: ${err.message}`;
        });
    }

    // ---------- Formata√ß√£o de Data (DD/MM/YYYY HH:mm:ss) ----------
    function formatarDataBR(dataStr) {
      if (!dataStr) return "";
      // se j√° estiver no formato DD/MM/YYYY HH:mm:ss, retorna direto
      if (/\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}/.test(dataStr)) {
        return dataStr;
      }
      const dt = new Date(dataStr);
      if (isNaN(dt)) return dataStr;
      const pad = n => String(n).padStart(2, "0");
      return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ` +
             `${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
    }

    // ---------- Carregar Postes do Firebase ----------
    function carregarPostes() {
      db.ref("postes").off("value");
      db.ref("postes").on("value", snapshot => {
        const obj = snapshot.val() || {};
        const lista = Object.entries(obj)
          .filter(([, v]) => v !== null)
          .map(([id, data]) => {
            // converte dataLancamento (string) em Date
            if (data.dataLancamento && typeof data.dataLancamento === "string") {
              const partes = data.dataLancamento.split(/[\s/:]+/).map(Number);
              if (partes.length >= 5) {
                data._dataConvertida = new Date(partes[2], partes[1]-1, partes[0], partes[3], partes[4], partes[5]||0);
              } else {
                data._dataConvertida = null;
              }
            }
            return { id, ...data };
          });
        // ordena do mais recente para o mais antigo
        lista.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));
        todosOsPostes = lista;
        popularFiltroProjetos(lista);
        paginaAtual = 1;
        filtrarPostes();
      });
    }

    // ---------- Popular filtro de Projetos ----------
    function popularFiltroProjetos(lista) {
      const select = document.getElementById("filtroProjeto");
      const projetosUnicos = [...new Set(lista.map(p => p.idProjeto).filter(Boolean))];
      select.innerHTML = '<option value="">Todos</option>';
      projetosUnicos.forEach(proj => {
        const opt = document.createElement("option");
        opt.value = proj.trim().toLowerCase();
        opt.textContent = proj;
        select.appendChild(opt);
      });
    }

    // ---------- Normaliza√ß√£o de Texto ----------
    function normalizarTexto(txt) {
      return (txt || "").toString().trim().toLowerCase();
    }

    // ---------- Filtrar + Paginar + Exibir ----------
    function filtrarPostes() {
      const filtroProjeto = normalizarTexto(document.getElementById("filtroProjeto")?.value);
      const filtroPoste   = normalizarTexto(document.getElementById("filtroPoste")?.value);
      const filtroUsuario = normalizarTexto(document.getElementById("usuario")?.value);
      const filtroStatus  = normalizarTexto(document.getElementById("filtroStatus")?.value);
      const dataInicial   = document.getElementById("dataInicial").value;
      const dataFinal     = document.getElementById("dataFinal").value;

      let listaFiltrada = todosOsPostes.filter(p => {
        const data = p._dataConvertida;
        const okProjeto = !filtroProjeto || normalizarTexto(p.idProjeto) === filtroProjeto;
        const okPoste   = !filtroPoste   || normalizarTexto(p.codigoPoste).includes(filtroPoste);
        const okUsuario = !filtroUsuario || normalizarTexto(p.usuario).includes(filtroUsuario);
        const okStatus  = !filtroStatus  || normalizarTexto(p.status) === filtroStatus;
        let okData = true;
        if (dataInicial) {
          const dtIni = new Date(`${dataInicial}T00:00:00`);
          okData = data instanceof Date && data >= dtIni;
        }
        if (okData && dataFinal) {
          const dtFim = new Date(`${dataFinal}T23:59:59`);
          okData = data instanceof Date && data <= dtFim;
        }
        return okProjeto && okPoste && okUsuario && okStatus && okData;
      });

      listaFiltrada.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

      const totalPaginas = Math.ceil(listaFiltrada.length / itensPorPagina);
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim    = inicio + itensPorPagina;
      listaVisivel = listaFiltrada.slice(inicio, fim);

      exibirPostes(listaVisivel);
      mostrarMapa(listaVisivel);
      atualizarPaginacao(totalPaginas);
      atualizarContadorStatus();
    }

    // ---------- Atualizar Pagina√ß√£o ----------
    function atualizarPaginacao(totalPaginas) {
      const pagDiv = document.getElementById("paginacao");
      pagDiv.innerHTML = "";
      for (let i = 1; i <= totalPaginas; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.disabled = i === paginaAtual;
        btn.onclick = () => {
          paginaAtual = i;
          filtrarPostes();
        };
        pagDiv.appendChild(btn);
      }
    }

    // ---------- Exibir Linhas na Tabela ----------
    function exibirPostes(lista) {
      const tbody = document.querySelector("#tabelaPostes tbody");
      tbody.innerHTML = "";
      lista.forEach(p => {
        const tr = document.createElement("tr");
        const status = normalizarTexto(p.status || "em andamento");
        tr.innerHTML = `
          <td><span>${p.dataLancamento || ""}</span></td>
          <td><input type="text" value="${p.idProjeto||""}" disabled></td>
          <td><input type="text" value="${p.codigoPoste||""}" disabled></td>
          <td><input type="text" value="${p.postePrimario||""}" disabled></td>
          <td><input type="text" value="${p.estruturaPrimaria||""}" disabled></td>
          <td><input type="text" value="${p.posteSecundario||""}" disabled></td>
          <td><input type="text" value="${p.estruturaSecundaria||""}" disabled></td>
          <td><textarea disabled>${p.linhaViva||""}</textarea></td>
          <td><textarea disabled>${p.servicosPodas||""}</textarea></td>
          <td><textarea disabled>${p.observacoes||""}</textarea></td>
          <td>${
            p.foto1
              ? `<a href="${p.foto1}" target="_blank">
                   <img class="miniatura" src="${p.foto1}" alt="Foto1">
                 </a>`
              : ``
          }</td>
          <td>${
            p.foto2
              ? `<a href="${p.foto2}" target="_blank">
                   <img class="miniatura" src="${p.foto2}" alt="Foto2">
                 </a>`
              : ``
          }</td>
          <td>${
            p.foto3
              ? `<a href="${p.foto3}" target="_blank">
                   <img class="miniatura" src="${p.foto3}" alt="Foto3">
                 </a>`
              : ``
          }</td>
          <td><input type="text" value="${p.latitude||""}" readonly></td>
          <td><input type="text" value="${p.longitude||""}" readonly></td>
          <td><input type="text" value="${p.usuario||""}" readonly></td>
          <td>
            <select disabled>
              <option value="em andamento" ${status==="em andamento"? "selected":""}>Em andamento</option>
              <option value="conclu√≠do"    ${status==="conclu√≠do"   ? "selected":""}>Conclu√≠do</option>
            </select>
          </td>
          <td><button onclick="editar(this)">‚úèÔ∏è</button></td>
          <td><button class="delete-btn" onclick="excluir(this)">üóëÔ∏è</button></td>
        `;
        tr.dataset.id = p.id;
        tbody.appendChild(tr);
      });
    }

    // ---------- Editar / Salvar / Excluir ----------
    function editar(botao) {
      const tr = botao.closest("tr");
      const salva = botao.textContent === "Salvar";
      if (salva) {
        salvar(tr);
        botao.textContent = "‚úèÔ∏è";
        tr.querySelectorAll("input, textarea, select").forEach(el => {
          if (el.tagName==="INPUT"||el.tagName==="TEXTAREA") {
            el.disabled = true; el.readOnly = true;
          } else {
            el.disabled = true;
          }
        });
      } else {
        botao.textContent = "Salvar";
        tr.querySelectorAll("input, textarea, select").forEach(el => {
          const td = el.closest("td");
          if (!td) return;
          const colIndex = Array.from(tr.children).indexOf(td);
          const bloqueadas = [0, 15]; // Data e Usu√°rio
          if (!bloqueadas.includes(colIndex)) {
            el.tagName==="SELECT" ? el.disabled=false : (el.disabled=false, el.readOnly=false);
          }
        });
      }
    }

    async function salvar(tr) {
      const btnSalvar = tr.querySelector("button");
      btnSalvar.disabled = true;
      btnSalvar.textContent = "üîÑ";

      const id            = tr.dataset.id;
      const dataLanc      = tr.children[0].innerText || "";
      const idProj        = tr.children[1].querySelector("input").value.trim() || "";
      const codPoste      = tr.children[2].querySelector("input").value.trim() || "";
      const postePrimario = tr.children[3].querySelector("input").value.trim() || "";
      const estrPrimaria  = tr.children[4].querySelector("input").value.trim() || "";
      const posteSec      = tr.children[5].querySelector("input").value.trim() || "";
      const estrSecund    = tr.children[6].querySelector("input").value.trim() || "";
      const linhaViva     = tr.children[7].querySelector("textarea").value.trim() || "";
      const servPodas     = tr.children[8].querySelector("textarea").value.trim() || "";
      const obs           = tr.children[9].querySelector("textarea").value.trim() || "";
      const foto1         = tr.children[10].querySelector("img")?.src || "";
      const foto2         = tr.children[11].querySelector("img")?.src || "";
      const foto3         = tr.children[12].querySelector("img")?.src || "";
      const lat           = tr.children[13].querySelector("input").value.trim() || "";
      const lng           = tr.children[14].querySelector("input").value.trim() || "";
      const usuario       = tr.children[15].querySelector("input").value.trim() || "";
      const status        = tr.children[16].querySelector("select")?.value || "";

      try {
        await db.ref(`postes/${id}`).update({
          dataLancamento: dataLanc,
          idProjeto:      idProj,
          codigoPoste:    codPoste,
          postePrimario,
          estruturaPrimaria:   estrPrimaria,
          posteSecundario:     posteSec,
          estruturaSecundaria: estrSecund,
          linhaViva,
          servicosPodas: servPodas,
          observacoes:   obs,
          foto1,
          foto2,
          foto3,
          latitude:      lat,
          longitude:     lng,
          usuario,
          status
        });
        alert("‚úÖ Poste atualizado com sucesso!");
        filtrarPostes();
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao salvar: ${err.message}`);
      }

      btnSalvar.disabled = false;
      btnSalvar.textContent = "‚úèÔ∏è";
    }

    async function excluir(botao) {
      const tr = botao.closest("tr");
      const id = tr.dataset.id;
      if (!confirm("Deseja realmente excluir este poste?")) return;
      botao.disabled = true;
      botao.textContent = "...";
      try {
        await db.ref(`postes/${id}`).remove();
        tr.remove();
        alert("‚úÖ Poste removido do Firebase!");
        filtrarPostes();
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao excluir: ${err.message}`);
      }
      botao.disabled = false;
      botao.textContent = "üóëÔ∏è";
    }

    // ---------- Sum√°rios de Podas e Linha Viva ----------
    function somarValor(labelField, statusField, lista) {
      let total = 0;
      lista.forEach(p => {
        const texto = (p[labelField] || "").trim().toLowerCase();
        const stat  = (p[statusField] || "").trim().toLowerCase();
        if (texto && texto !== "n√£o recebido" && stat !== "conclu√≠do") {
          const matches = texto.match(/r\$ ?[\d.,]+/gi);
          if (matches) matches.forEach(val => {
            const num = parseFloat(val.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
            total += num;
          });
        }
      });
      return total;
    }

    function atualizarContadorStatus() {
      const lista = todosOsPostes;
      const totalProj = new Set(lista.map(p => (p.idProjeto||"").trim()).filter(x => x!=="")).size;
      const totalPostes = lista.length;
      const concluidos = lista.filter(p => normalizarTexto(p.status) === "conclu√≠do").length;
      const andamento  = lista.filter(p => normalizarTexto(p.status) === "em andamento").length;
      const comPodas   = lista.filter(p => { 
        const pod = (p.servicosPodas||"").trim().toLowerCase();
        return pod && pod !== "n√£o recebido";
      }).length;
      const podasPend  = lista.filter(p => {
        const pod = (p.servicosPodas||"").trim().toLowerCase();
        const st  = (p.status||"").trim().toLowerCase();
        return pod && pod !== "n√£o recebido" && st !== "conclu√≠do";
      }).length;
      const comLV    = lista.filter(p => {
        const lv = (p.linhaViva||"").trim().toLowerCase();
        return lv && lv !== "n√£o recebido" && lv !== "selecione os servi√ßos";
      }).length;
      const lvPend   = lista.filter(p => {
        const lv = (p.linhaViva||"").trim().toLowerCase();
        const st = (p.status||"").trim().toLowerCase();
        return lv && lv !== "n√£o recebido" && lv !== "selecione os servi√ßos" && st !== "conclu√≠do";
      }).length;
      const totalLV   = somarValor("linhaViva", "status", lista);
      const totalLVf  = totalLV > 0 
                       ? totalLV.toLocaleString("pt-BR", { style:"currency", currency:"BRL"}) 
                       : null;

      const agora = new Date();
      const horaAtual = agora.toLocaleTimeString("pt-BR", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
      const dataAtual = agora.toLocaleDateString("pt-BR");

      let msg = `üìö ${totalProj} projetos | üî¢ ${totalPostes} postes | ‚úÖ ${concluidos} conclu√≠dos | üõ† ${andamento} em andamento | üåø ${comPodas} com poda | üï≥Ô∏è ${podasPend} podas pendentes | ‚ö° ${comLV} com linha viva | ‚è≥ ${lvPend} linha viva pendente`;
      if (totalLVf) msg += ` | üí∞ Total LV: ${totalLVf}`;
      msg += ` | üïí Atualizado em: ${dataAtual} √†s ${horaAtual}`;

      document.getElementById("contadorStatus").innerText = msg;
    }

    // ---------- Mostrar Mapa com Markers ----------
    function mostrarMapa(lista) {
      const bounds = new google.maps.LatLngBounds();
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 6,
        center: { lat:-8.0, lng:-35.0 },
        gestureHandling: "greedy",
        zoomControl: true,
        mapTypeControl: true,
        mapTypeControlOptions: { style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR, position: google.maps.ControlPosition.TOP_RIGHT },
        streetViewControl: false,
        fullscreenControl: true
      });
      const geocoder = new google.maps.Geocoder();

      // limpa marcadores antigos
      markers.forEach(m => {
        if (m.markerInstance) m.markerInstance.setMap(null);
        if (m.intervalId) clearInterval(m.intervalId);
      });
      markers = [];

      lista.forEach(p => {
        const lat = parseFloat(p.latitude), lng = parseFloat(p.longitude);
        if (isNaN(lat) || isNaN(lng)) return;

        const st = normalizarTexto(p.status || "");
        const iconUrl = (st === "" || st === "em andamento")
                      ? "andamento.png"
                      : "poste.png";

        const marker = new google.maps.Marker({
          position: {lat, lng},
          map,
          title: `Poste: ${p.codigoPoste||""}`,
          icon: { url: iconUrl, scaledSize: new google.maps.Size(32,32) }
        });

        let infoContent = `
          <div style="max-width:250px;font-family:Roboto,sans-serif;font-size:12px;color:#333">
            <div style="background:#004d40;color:#fff;padding:12px 16px">
              <div style="font-size:16px;font-weight:600">üìÅ Projeto: ${p.idProjeto||"N/A"}</div>
              <div style="font-size:13px">üîñ PG: ${p.codigoPoste||"-"}</div>
            </div>
            <div style="padding:10px 14px;display:grid;grid-template-columns:1fr;gap:6px">
              <div>üìÖ <b>Data:</b> ${p.dataLancamento||"-"}</div>
              <div>üèóÔ∏è <b>Estrutura Prim√°ria:</b> ${p.estruturaPrimaria||"-"}</div>
              <div>üìç <b>Poste Prim√°rio:</b> ${p.postePrimario||"-"}</div>
              <div>üîó <b>Poste Secund√°rio:</b> ${p.posteSecundario||"-"}</div>
              <div>‚öôÔ∏è <b>Estrutura Secund√°ria:</b> ${p.estruturaSecundaria||"-"}</div>
              <div>‚ö° <b>Linha Viva:</b> ${p.linhaViva||"-"}</div>
              ${p.servicosPodas?.trim() 
                ? `<div>üåø <b>Serv. Podas:</b> ${p.servicosPodas}</div>` 
                : ``
              }
              <div>üìù <b>Obs.:</b> ${p.observacoes||"-"}</div>
              <div>üì° <b>Lat/Lon:</b> ${p.latitude||"-"}, ${p.longitude||"-"}</div>
              <div>üü¢ <b>Status:</b> <span style="color:${p.status==="conclu√≠do"?"#2e7d32":"#ff9800"}">${p.status||"Em andamento"}</span></div>
              <div>üë§ <b>Usu√°rio:</b> ${p.usuario||"-"}</div>
              <div id="muni-${p.id}" style="display:none; margin-top:4px">
                üó∫Ô∏è <b>Munic√≠pio:</b> <span id="muni-text-${p.id}">Carregando...</span>
              </div>
            </div>
            ${
              (p.foto1 || p.foto2 || p.foto3) 
                ? `<div style="padding:8px 14px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                    ${p.foto1 ? `<a href="${p.foto1}" target="_blank"><img src="${p.foto1}" style="width:50px;height:50px;border-radius:6px;object-fit:cover;border:1px solid #ccc" onerror="this.src='no-image.png'"></a>` : ``}
                    ${p.foto2 ? `<a href="${p.foto2}" target="_blank"><img src="${p.foto2}" style="width:50px;height:50px;border-radius:6px;object-fit:cover;border:1px solid #ccc" onerror="this.src='no-image.png'"></a>` : ``}
                    ${p.foto3 ? `<a href="${p.foto3}" target="_blank"><img src="${p.foto3}" style="width:50px;height:50px;border-radius:6px;object-fit:cover;border:1px solid #ccc" onerror="this.src='no-image.png'"></a>` : ``}
                  </div>
                  <div style="padding:10px 14px;text-align:center">
                    <button onclick="abrirTabelaCompleta('${p.foto1}','${p.foto2}','${p.foto3}')" 
                      style="background:#1976d2;color:#fff;border:none;padding:6px 10px;font-size:12px;font-weight:bold;border-radius:4px;cursor:pointer">
                      üîç Ver Fotos
                    </button>
                  </div>`
                : ``
            }
          </div>
        `;
        const infoWindow = new google.maps.InfoWindow({ content: infoContent });
        marker.addListener("click", () => infoWindow.open(map, marker));

        geocoder.geocode({ location: { lat, lng } }, (results, statusGeo) => {
          let muni = "N√£o dispon√≠vel";
          if (statusGeo === "OK" && results.length) {
            for (const res of results) {
              const comp = res.address_components.find(c => c.types.includes("administrative_area_level_2") || c.types.includes("locality"));
              if (comp) { muni = comp.long_name; break; }
            }
          }
          const elCont = document.getElementById(`muni-${p.id}`);
          const elTxt  = document.getElementById(`muni-text-${p.id}`);
          if (elCont && elTxt) {
            elTxt.textContent = muni;
            elCont.style.display = "block";
          }
        });

        markers.push({ markerInstance: marker });
        bounds.extend(marker.getPosition());
      });

      if (!bounds.isEmpty()) map.fitBounds(bounds);
    }

    function abrirTabelaCompleta(f1, f2, f3) {
      const html = `
        <html>
          <head>
            <title>Fotos do Poste</title>
            <style>
              body { font-family: sans-serif; background: #f0f0f0; padding:20px;
                     display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
              img { border-radius:10px; border:1px solid #ccc; max-width:90%; height:auto; object-fit:contain; }
            </style>
          </head>
          <body>
            ${f1&&f1!=="undefined"?`<img src="${f1}" onerror="this.src='no-image.png'">`:""}
            ${f2&&f2!=="undefined"?`<img src="${f2}" onerror="this.src='no-image.png'">`:""}
            ${f3&&f3!=="undefined"?`<img src="${f3}" onerror="this.src='no-image.png'">`:""}
          </body>
        </html>`;
      const win = window.open("", "_blank");
      win.document.write(html);
      win.document.close();
    }

    // ---------- Exportar CSV ----------
    function exportarCSV(tudo=false) {
      const headers = [
        "Data/Hora","ID Projeto","PG","Poste Prim√°rio","Estrutura Prim√°ria",
        "Poste Secund√°rio","Estrutura Secund√°ria","Linha Viva","Servi√ßos Podas",
        "Observa√ß√µes","Imagem 1 (URL)","Imagem 2 (URL)","Imagem 3 (URL)",
        "Latitude","Longitude","Usu√°rio","Status"
      ];
      const linhas = [headers];
      const fonte = tudo ? todosOsPostes : listaVisivel;
      if (!fonte || !fonte.length) {
        // caso queira apenas as linhas vis√≠veis j√° renderizadas, poderia varrer a tabela,
        // mas para simplificar usamos listaVisivel mesmo
      }
      fonte.forEach(p => {
        linhas.push([
          formatarDataBR(p.dataLancamento||""),
          p.idProjeto||"", p.codigoPoste||"", p.postePrimario||"", p.estruturaPrimaria||"",
          p.posteSecundario||"", p.estruturaSecundaria||"", p.linhaViva||"", p.servicosPodas||"",
          p.observacoes||"", p.foto1||"", p.foto2||"", p.foto3||"", p.latitude||"",
          p.longitude||"", p.usuario||"", p.status||""
        ]);
      });
      const csv = "\uFEFF" + linhas.map(l => l.map(v => `"${v}"`).join(";")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const dataHoje = new Date().toISOString().split("T")[0];
      link.href = URL.createObjectURL(blob);
      link.download = tudo
        ? `postes_todos_${dataHoje}.csv`
        : `postes_pagina_${paginaAtual}_${dataHoje}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ---------- Gera√ß√£o de PDF no estilo ‚Äúlinha a linha‚Äù ----------
    async function toDataURL(url) {
      try {
        const resp = await fetch(url);
        const blob = await resp.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onloadend = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsDataURL(blob);
        });
      } catch {
        return null;
      }
    }

   /**
 * Converte uma URL remota (Firebase Storage) em Base64.
 * @param {string} url - URL completa do Storage (por ex. "https://firebasestorage.googleapis.com/...")
 * @returns {Promise<string|null>} - string "data:image/jpeg;base64,..." ou null em caso de falha
 */
async function toDataURL(url) {
  try {
    console.log("[toDataURL] Iniciando fetch da URL:", url);
    const response = await fetch(url, { mode: "cors" });
    console.log("[toDataURL] status da resposta:", response.status, response.ok);

    if (!response.ok) {
      console.warn("[toDataURL] fetch retornou ok=false para URL:", url);
      return null;
    }

    const blob = await response.blob();
    console.log("[toDataURL] Blob recebido (bytes):", blob.size);

    return await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        // reader.result ser√° "data:image/jpeg;base64,/9j/4AAQSkZJRgA..."
        console.log("[toDataURL] FileReader result (tamanho):", reader.result.length);
        resolve(reader.result.toString());
      };
      reader.onerror = (err) => {
        console.error("[toDataURL] FileReader error para URL:", url, err);
        reject(null);
      };
      reader.readAsDataURL(blob);
    });
  } catch (err) {
    console.error("[toDataURL] Erro no fetch ou na convers√£o:", url, err);
    return null;
  }
}

/**
 * Gera e baixa um PDF contendo todos os "postes" em docs, com
 * miniaturas das imagens (foto1, foto2, foto3) convertidas em Base64.
 */
async function baixarPDFModelo() {
  // 'listaVisivel' ou 'todosOsPostes' devem ser arrays de objetos no formato:
  // {
  //   dataLancamento: "01/06/2025 20:08:42",
  //   idProjeto: "dsisj",
  //   codigoPoste: "xx",
  //   postePrimario: "11/1500R.",
  //   estruturaPrimaria: "B1/3-CCL",
  //   posteSecundario: "8/200 EXISTENTE.",
  //   estruturaSecundaria: "ITA-IMR, IT1",
  //   linhaViva: "Inst est cruz‚Ä¶",
  //   servicosPodas: "Corte De √Årvore‚Ä¶",
  //   observacoes: "sjsjsj",
  //   latitude: "-8.6384811",
  //   longitude: "-35.2697999",
  //   usuario: "luizvicentemobile@gmail.com",
  //   status: "",
  //   foto1: "https://firebasestorage.googleapis.com/‚Ä¶/postes%2Fxx%2Ffoto1.jpg?alt=media&token=‚Ä¶",
  //   foto2: "https://firebasestorage.googleapis.com/‚Ä¶/postes%2Fxx%2Ffoto2.jpg?alt=media&token=‚Ä¶",
  //   foto3: "https://firebasestorage.googleapis.com/‚Ä¶/postes%2Fxx%2Ffoto3.jpg?alt=media&token=‚Ä¶"
  // }

  const docs = (listaVisivel?.length ? listaVisivel : todosOsPostes) || [];
  if (!docs.length) {
    alert("‚ùå Nenhum poste dispon√≠vel para gerar o PDF.");
    return;
  }

  // 1) Extrai URLs √∫nicas de fotos
  const urls = [
    ...new Set(
      docs
        .flatMap((p) => [p.foto1, p.foto2, p.foto3])
        .filter((u) => typeof u === "string" && u.trim() !== "")
    ),
  ];
  console.log("[baixarPDFModelo] URLs √∫nicas encontradas:", urls);

  // 2) Converte cada URL em Base64 e salva em imgMap: { url ‚Üí base64 }
  const imgMap = {};
  await Promise.all(
    urls.map(async (u) => {
      console.log("[baixarPDFModelo] Convertendo URL em Base64:", u);
      const b64 = await toDataURL(u);
      if (b64) {
        imgMap[u] = b64;
        console.log("[baixarPDFModelo] Convers√£o bem-sucedida para URL:", u);
      } else {
        console.warn("[baixarPDFModelo] Falhou ao converter para Base64:", u);
      }
    })
  );
  console.log("[baixarPDFModelo] Mapeamento final imgMap:", imgMap);

  // 3) Instancia jsPDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4", orientation: "portrait" });
  const pageW = doc.internal.pageSize.getWidth();
  const margin = 40;
  const lineH = 18;
  const fTitle = 18,
    fText = 12;

  // 4) Para cada poste em 'docs', gera uma p√°gina no PDF
  docs.forEach((p, i) => {
    if (i > 0) doc.addPage();

    let y = margin;
    // --- Cabe√ßalho ---
    doc.setFontSize(fTitle);
    doc.setFont("helvetica", "bold");
    doc.text("Relat√≥rio de Postes Atbuilt", pageW / 2, y, { align: "center" });
    y += 30;

    doc.setLineWidth(0.5);
    doc.setDrawColor(100);
    doc.line(margin, y, pageW - margin, y);
    y += 25;

    // --- N¬∫ e Data ---
    doc.setFontSize(fText);
    doc.setFont("helvetica", "normal");
    doc.text(`N¬∞ ${i + 1}`, margin, y);
    y += lineH;

    // --- Campos de texto ---
    const campos = [
      ["Data", formatarDataBR(p.dataLancamento || "")],
      ["ID Projeto", p.idProjeto || ""],
      ["PG", p.codigoPoste || ""],
      ["Poste Prim√°rio", p.postePrimario || ""],
      ["Estrutura Prim√°ria", p.estruturaPrimaria || ""],
      ["Poste Secund√°rio", p.posteSecundario || ""],
      ["Estrutura Secund√°ria", p.estruturaSecundaria || ""],
      ["Linha Viva", p.linhaViva || ""],
      ["Podas", p.servicosPodas || ""],
      ["Observa√ß√µes", p.observacoes || ""],
      [
        "Lat/Lng",
        (p.latitude || "") +
          (p.latitude && p.longitude ? " - " : "") +
          (p.longitude || ""),
      ],
      ["Usu√°rio", p.usuario || ""],
      ["Status", p.status || ""],
    ];

    campos.forEach(([lbl, val]) => {
      doc.setFont("helvetica", "bold");
      doc.text(`${lbl}:`, margin, y);

      doc.setFont("helvetica", "normal");
      const prefix = `${lbl}: `;
      const xVal = margin + doc.getTextWidth(prefix) + 5;
      const maxW = pageW - margin - xVal;
      const split = doc.splitTextToSize(val, maxW);
      doc.text(split, xVal, y);
      y += lineH * split.length;
    });

    y += 10;

    // --- Desenho das miniaturas (foto1, foto2, foto3) ---
    const imgSize = 80; // largura e altura das miniaturas
    const space = 10; // espa√ßo entre cada miniatura
    let xImg = margin;

    [p.foto1, p.foto2, p.foto3].forEach((u) => {
      if (u && imgMap[u]) {
        // Detecta o tipo de imagem (JPEG ou PNG) a partir da string Base64
        const mimeType = imgMap[u].startsWith("data:image/png")
          ? "PNG"
          : "JPEG";
        console.log("[baixarPDFModelo] Adicionando imagem no PDF:", u, "tipo:", mimeType);
        doc.addImage(imgMap[u], mimeType, xImg, y, imgSize, imgSize);
      } else if (u) {
        // Se a URL existe mas n√£o foi poss√≠vel converter, desenha ret√¢ngulo vazio
        console.warn("[baixarPDFModelo] Sem Base64 para URL:", u, "- desenhando ret√¢ngulo");
        doc.setDrawColor(200);
        doc.rect(xImg, y, imgSize, imgSize);
      }
      xImg += imgSize + space;
    });
  });

  // 5) Salvar e baixar o PDF
  const hoje = new Date();
  const dd = String(hoje.getDate()).padStart(2, "0");
  const mm = String(hoje.getMonth() + 1).padStart(2, "0");
  const yyyy = hoje.getFullYear();
  doc.save(`postes_${dd}-${mm}-${yyyy}.pdf`);
}


    // ---------- Toggle Power BI ----------
    function togglePowerBI() {
      const main = document.getElementById("mainContent");
      const pbi  = document.getElementById("powerbiContainer");
      if (pbi.style.display === "none") {
        main.style.display = "none";
        pbi.style.display = "block";
      } else {
        pbi.style.display = "none";
        main.style.display = "block";
      }
    }

    // ---------- Toggle Podas e Linha Viva ----------
    function togglePodas() {
      mostrandoSomentePodas = !mostrandoSomentePodas;
      if (mostrandoSomentePodas) {
        const lista = todosOsPostes.filter(p => {
          const pod = (p.servicosPodas||"").trim().toLowerCase();
          const st  = (p.status||"").trim().toLowerCase();
          return pod && pod !== "n√£o recebido" && st !== "conclu√≠do";
        });
        if (!lista.length) {
          alert("Nenhum poste com servi√ßo de poda em andamento.");
          mostrandoSomentePodas = false;
          return;
        }
        exibirPostes(lista);
        mostrarMapa(lista);
        document.getElementById("btnMostrarPodas").textContent = "üìå Mostrar Todos";
      } else {
        exibirPostes(listaVisivel);
        mostrarMapa(listaVisivel);
        document.getElementById("btnMostrarPodas").textContent = "üåø Mostrar Podas";
      }
    }

    function toggleLinhaViva() {
      mostrandoSomenteLinhaViva = !mostrandoSomenteLinhaViva;
      if (mostrandoSomenteLinhaViva) {
        const lista = todosOsPostes.filter(p => {
          const lv = (p.linhaViva||"").trim().toLowerCase();
          const st = (p.status||"").trim().toLowerCase();
          return lv && lv !== "n√£o recebido" && st !== "conclu√≠do";
        });
        if (!lista.length) {
          alert("Nenhum poste com linha viva em andamento.");
          mostrandoSomenteLinhaViva = false;
          return;
        }
        exibirPostes(lista);
        mostrarMapa(lista);
        document.getElementById("btnMostrarLinhaViva").textContent = "‚ö° Mostrar Todos";
      } else {
        exibirPostes(listaVisivel);
        mostrarMapa(listaVisivel);
        document.getElementById("btnMostrarLinhaViva").textContent = "‚ö° Mostrar Linha Viva";
      }
    }
  </script>
</body>
</html>

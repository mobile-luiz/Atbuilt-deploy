<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atbuilt ‚Äì Sistema de Gest√£o de Postes</title>

  <link rel="icon" href="logo-atbuilt.png" type="image/png" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://unpkg.com/@googlemaps/markerclustererplus/dist/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/google-maps-utility-library-v3-infobox@latest/infobox.min.js"></script>

  <link rel="stylesheet" href="estilos.css" />

  <style>
    /* ================== Estilos Gerais ================== */
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    h2 { 
      margin-bottom: 16px; 
      color: #333;
    }

    /* ===== Tela de Login ===== */
    .login-container {
      display: flex; 
      align-items: center; 
      justify-content: center;
      height: 100vh;
      padding: 20px;
    }
    
    .login-box {
      background: white; 
      padding: 40px; 
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      border-top: 5px solid #667eea;
    }
    
    .login-box input {
      width: 100%; 
      margin-bottom: 15px; 
      padding: 12px; 
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      transition: all 0.3s;
    }
    
    .login-box input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }
    
    .login-box button {
      width: 100%;
      padding: 12px; 
      font-size: 16px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .login-box button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .login-erro { 
      margin-top: 12px; 
      color: #ff4757; 
      font-size: 13px; 
      text-align: center;
    }
    
    .login-logo {
      text-align: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .login-logo img {
      height: 50px;
      margin-bottom: 10px;
    }

    /* ===== Sistema ap√≥s login ===== */
    .sistema-container { 
      display: none; 
      padding: 20px;
      background: #f5f7fa;
      min-height: 100vh;
    }
    
    /* Top Bar */
    .top-bar {
      background: white;
      border-radius: 10px;
      padding: 15px 25px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    .top-bar h2 {
      margin: 0;
      color: #333;
      font-size: 20px;
    }
    
    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logout-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .site-logo {
      height: 35px;
    }
    
    .header {
      background: white; 
      border-radius: 10px; 
      padding: 20px; 
      margin-bottom: 20px;
      display: flex; 
      gap: 20px; 
      flex-wrap: wrap;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    .header div { 
      display: flex; 
      flex-direction: column; 
    }
    
    .header label { 
      font-weight: 600; 
      font-size: 13px; 
      margin-bottom: 6px;
      color: #555;
    }
    
    .header input, .header select {
      padding: 10px 12px; 
      font-size: 14px; 
      border: 1px solid #ddd; 
      border-radius: 6px;
      width: 200px;
      transition: all 0.3s;
    }
    
    .header input:focus, .header select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    .acoes {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .acoes button {
      padding: 10px 18px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      font-size: 14px; 
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .acoes button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .acoes button.success {
      background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    }
    
    .acoes button.warning {
      background: linear-gradient(135deg, #FF9800 0%, #EF6C00 100%);
    }
    
    .acoes button.danger {
      background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
    }

    #contadorStatus { 
      margin-bottom: 15px; 
      font-weight: 600;
      color: #333;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    #paginacao {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    #paginacao button {
      padding: 8px 14px;
      font-size: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    #paginacao button:hover:not(:disabled) {
      background: #5a6fd8;
      transform: translateY(-1px);
    }
    
    #paginacao button:disabled {
      background: #ddd;
      cursor: not-allowed;
    }
    
    #paginacao span {
      font-weight: bold;
      margin: 0 12px;
    }

    .scroll-table {
      max-height: 500px; 
      overflow-y: auto; 
      border: 1px solid #ddd;
      margin-bottom: 20px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    #tabelaPostes {
      width: 100%; 
      border-collapse: collapse; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #tabelaPostes th, #tabelaPostes td {
      padding: 12px 15px; 
      border: 1px solid #eee; 
      font-size: 13px; 
      white-space: nowrap;
    }
    
    #tabelaPostes th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: #fff; 
      position: sticky; 
      top: 0; 
      z-index: 1;
      font-weight: 600;
    }
    
    #tabelaPostes tbody tr:nth-child(even) {
      background: #f9f9f9;
    }
    
    #tabelaPostes tbody tr:hover {
      background: #f0f7ff;
    }
    
    .miniatura {
      width: 50px; 
      height: 50px; 
      object-fit: cover; 
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    
    button.delete-btn {
      background: transparent; 
      border: none; 
      font-size: 16px; 
      color: #ff4757; 
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s;
    }
    
    button.delete-btn:hover { 
      background: #ff4757;
      color: white;
    }
    
    .btn-edit {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .btn-edit:hover {
      background: #388E3C;
    }

    /* ========== Estilos de impress√£o (PDF) ========== */
    @media print {
      body { margin: 0; padding: 0; background: white; }
      #pdfContainer { width: 210mm; margin: 0 auto; }
      .acoes, .header input, .header select, #map, .mapa-container, #paginacao {
        display: none !important;
      }
      .scroll-table { max-height: none; }
      #tabelaPostes { width: 100%; table-layout: fixed; }
      #tabelaPostes th, #tabelaPostes td { word-wrap: break-word; }
    }

    /* Pequeno ajuste para coluna "Tempo em andamento" */
    #tabelaPostes td span {
      display: inline-block;
      min-width: 50px;
      text-align: center;
    }
    
    /* Mapa dos Postes */
    .map-title {
      margin: 20px 0 10px 0;
      color: #333;
      font-size: 18px;
    }
    
    .mapa-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 12px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
    }
    
    #map {
      height: 500px;
      width: 100%;
    }
    
    /* Power BI Container */
    .powerbi-container {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.08);
      position: relative;
      height: 80vh;
    }
    
    /* Loading */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .status-andamento {
      background: rgba(255, 152, 0, 0.1);
      color: #FF9800;
    }
    
    .status-concluido {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .header input, .header select {
        width: 180px;
      }
    }
    
    @media (max-width: 992px) {
      .header {
        flex-direction: column;
        gap: 15px;
      }
      
      .header input, .header select {
        width: 100%;
      }
      
      .acoes {
        justify-content: center;
      }
    }
    
    @media (max-width: 768px) {
      .sistema-container {
        padding: 15px;
      }
      
      .top-bar {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .top-bar-right {
        flex-direction: column;
      }
      
      .scroll-table {
        max-height: 400px;
      }
    }
  </style>
</head>

<body>
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h2 style="text-align: center; color: #333; margin-bottom: 25px;">Acesso ao Sistema</h2>
      
      <input type="text" id="loginEmail" placeholder="E-mail ou Usu√°rio" />
      <input type="password" id="loginSenha" placeholder="Senha" />
      
      <button onclick="fazerLogin()">Entrar</button>
      
      <div id="loginErro" class="login-erro"></div>
      
      <div class="login-logo">
        <img src="logo-atbuilt.png" alt="Logo" />
        <h3 style="font-size:16px; color:#1a202c; margin: 5px 0;">Atbuilt</h3>
        <p style="font-size:13px; color:#666;">Sistema de Gest√£o Inteligente</p>
      </div>
    </div>
  </div>

  <div id="sistemaContainer" class="sistema-container">
    <div class="top-bar">
      <h2>Atbuilt ‚Äì Sistema de Gest√£o de Postes</h2>
      <div class="top-bar-right">
        <button class="logout-btn" onclick="fazerLogout()">
          <span style="font-size: 16px;">üö™</span> Sair
        </button>
        <img src="logo-atbuilt.png" alt="Logo Atbuilt" class="site-logo" />
      </div>
    </div>

    <div class="header">
      <div>
        <label for="usuario">E-mail do usu√°rio</label>
        <input type="text" id="usuario" oninput="debouncedFiltrarPostes()" placeholder="Filtrar por usu√°rio" />
      </div>

      <div>
        <label for="filtroProjeto">ID do Projeto</label>
        <input type="text" id="filtroProjeto" oninput="debouncedFiltrarPostes()" placeholder="Filtrar por ID do Projeto" />
      </div>

      <div>
        <label for="filtroPoste">C√≥digo do Poste</label>
        <input type="text" id="filtroPoste" oninput="debouncedFiltrarPostes()" placeholder="Filtrar por c√≥digo" />
      </div>

      <div>
        <label for="filtroStatus">Status</label>
        <select id="filtroStatus" onchange="filtrarPostes()">
          <option value="">Todos</option>
          <option value="em andamento">Em andamento</option>
          <option value="conclu√≠do">Conclu√≠do</option>
        </select>
      </div>

      <div>
        <label for="dataInicial">De:</label>
        <input type="date" id="dataInicial" onchange="filtrarPostes()" />
      </div>
      
      <div>
        <label for="dataFinal">At√©:</label>
        <input type="date" id="dataFinal" onchange="filtrarPostes()" />
      </div>
    </div>

    <div class="acoes">

      <button onclick="baixarPDFModelo()">üìÑ Baixar PDF</button>
      <button id="btnPowerBI" onclick="togglePowerBI()">üìä Power BI</button>
      <button class="warning" id="btnMostrarPodas" onclick="togglePodas()">üåø Mostrar Podas</button>
      
    </div>

    <div id="contadorStatus"></div>

    <div id="paginacao"></div>

    <div class="scroll-table">
      <table id="tabelaPostes">
        <thead>
          <tr>
            <th>Data</th>
            <th>ID Projeto</th>
            <th>PG</th>
            <th>Poste Prim√°rio</th>
            <th>Estrut. Prim√°ria</th>
            <th>Poste Secund√°rio</th>
            <th>Estrut. Secund√°ria</th>
            <th>Linha Viva</th>
            <th>Servi√ßos Podas</th>
            <th>Observa√ß√µes</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Usu√°rio</th>
            <th>Status</th>
            <th>Tempo</th>
            <th>A√ß√µes</th>
            <th>Excluir</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 class="map-title">üìç Mapa dos Postes</h3>
    <div style="display: flex; gap: 16px; margin-bottom: 8px; align-items: center;">
      <div style="display: flex; align-items: center;">
        <span style="
          display: inline-block;
          width: 12px;
          height: 12px;
          background-color: #ffc107;
          border-radius: 50%;
          margin-right: 6px;
          box-shadow: 0 0 1px rgba(0,0,0,0.2);
        "></span>
        Em andamento
      </div>
      <div style="display: flex; align-items: center;">
        <span style="
          display: inline-block;
          width: 12px;
          height: 12px;
          background-color: #dc3545;
          border-radius: 50%;
          margin-right: 6px;
          box-shadow: 0 0 1px rgba(0,0,0,0.2);
        "></span>
        Conclu√≠do
      </div>
    </div>
    
    <div id="map" class="mapa-container" style="height:400px; margin-top:12px;"></div>

    <div id="powerbiContainer" class="powerbi-container" style="display: none; width: 100%; height: 80vh; position: relative;">
      <button onclick="togglePowerBI()" style="position: absolute; top: 16px; right: 16px; z-index: 10; background: #1e88e5; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
        ‚Üê Voltar ao Painel
      </button>
      <iframe
        title="Atbuilt atual"
        width="100%"
        height="100%"
        src="https://app.powerbi.com/view?r=eyJrIjoiOGU1YzAwZTEtZTViZS00YWY5LThlOWYtMDVhODU2NmMzODMwIiwidCI6ImMyNGEyNGRjLWJjYTAtNGYyYS1hOTRmLWY3NDVkNDdkZTE4MCJ9"
        frameborder="0"
        allowFullScreen="true"
        style="border: none;"
      ></iframe>
    </div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNfO72QTnIMEn2g743sO_5UR5o-2KmEig&callback=inicializarMapa" async defer></script>

  <script>
    // ========== CONFIGURA√á√ÉO FIREBASE ==========
    const firebaseConfig = {
      apiKey: "AIzaSyC_z3mtM3e5stpmRU_XLT2JfBw9jjF9rXY",
      databaseURL: "https://atbuilt-7dd80-default-rtdb.firebaseio.com",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ========== VARI√ÅVEIS GLOBAIS ==========
    let todosOsPostes = [];
    let listaFiltrada = [];
    let listaVisivel = [];
    let paginaAtual = 1;
    const itensPorPagina = 200;
    let map = null;
    let markers = new Map();
    let markerCluster = null;
    let infoWindows = new Map();
    let geocoder = null;
    let cachedMunicipalities = new Map();
    let mostrandoSomentePodas = false;
    let mostrandoSomenteLinhaViva = false;
    let mapaInicializado = false;
    let debounceTimer = null;
    let userEmail = "";

    // ========== DEBOUNCE PARA FILTRAGEM ==========
    function debouncedFiltrarPostes() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => filtrarPostes(), 300);
    }

    // ========== INICIALIZAR MAPA ==========
    function inicializarMapa() {
      if (mapaInicializado) return;
      
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -8.0, lng: -35.0 },
        zoom: 6,
        gestureHandling: "greedy",
        zoomControl: true,
        mapTypeControl: true,
        streetViewControl: false,
        fullscreenControl: true,
        styles: [
          {
            featureType: 'poi',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }]
          }
        ]
      });
      
      geocoder = new google.maps.Geocoder();
      mapaInicializado = true;
      
      if (window.MarkerClusterer) {
        markerCluster = new MarkerClusterer(map, [], {
          imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m',
          minimumClusterSize: 2,
          maxZoom: 15
        });
      }
    }

    // ========== LIMPAR MAPA COMPLETAMENTE ==========
    function limparMapaCompletamente() {
      if (markerCluster) markerCluster.clearMarkers();
      
      markers.forEach((markerData) => {
        if (markerData.marker) markerData.marker.setMap(null);
      });
      
      infoWindows.forEach((infoWindow) => infoWindow.close());
      
      markers.clear();
      infoWindows.clear();
      cachedMunicipalities.clear();
    }

    // ========== MOSTRAR MAPA OTIMIZADO ==========
    async function mostrarMapaOtimizado(lista) {
      if (!mapaInicializado) {
        setTimeout(() => mostrarMapaOtimizado(lista), 100);
        return;
      }
      
      limparMapaCompletamente();
      
      const novosMarkers = [];
      const bounds = new google.maps.LatLngBounds();
      
      // Processar em lotes para performance
      const batchSize = 50;
      for (let i = 0; i < lista.length; i += batchSize) {
        const batch = lista.slice(i, i + batchSize);
        await Promise.all(batch.map((poste) => criarMarkerAsync(poste)));
      }
      
      if (markerCluster) {
        novosMarkers.forEach(marker => markerCluster.addMarker(marker));
      }
      
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds, { padding: 50 });
      }
      
      async function criarMarkerAsync(poste) {
        const lat = parseFloat(poste.latitude);
        const lng = parseFloat(poste.longitude);
        if (isNaN(lat) || isNaN(lng)) return;
        
        // --- USANDO POSTE.PNG ---
        const iconUrl = "poste.png";
        
        const marker = new google.maps.Marker({
          position: { lat, lng },
          map: map,
          title: `${poste.codigoPoste || "Poste"} - ${poste.idProjeto || "Projeto"}`,
          icon: {
            url: iconUrl,
            scaledSize: new google.maps.Size(40, 40)
          },
          optimized: true
        });
        
        bounds.extend(marker.position);
        
        const infoWindow = new google.maps.InfoWindow({
          content: criarConteudoInfoWindow(poste),
          maxWidth: 300
        });
        
        marker.addListener("click", () => {
          infoWindows.forEach(iw => iw.close());
          infoWindow.open(map, marker);
        });
        
        markers.set(poste.id, { marker, infoWindow, data: poste });
        infoWindows.set(poste.id, infoWindow);
        novosMarkers.push(marker);
        
        buscarMunicipioAsync(poste.id, lat, lng);
      }
    }

    function criarConteudoInfoWindow(poste) {
      const status = normalizarTexto(poste.status);
      const muni = cachedMunicipalities.get(poste.id) || "Carregando...";
      const tempo = poste.tempoDecorrido ? 
        `${poste.tempoDecorrido.dias}d ${poste.tempoDecorrido.horas}h` : "-";
      
      return `
        <div style="padding: 12px; max-width: 280px; font-family: 'Segoe UI', sans-serif;">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px 8px 0 0; margin: -12px -12px 12px -12px;">
            <div style="font-size: 16px; font-weight: 600;">üìÅ ${poste.idProjeto || "Sem projeto"}</div>
            <div style="font-size: 13px; opacity: 0.9;">üîñ ${poste.codigoPoste || "Sem c√≥digo"}</div>
          </div>
          <div style="font-size: 13px; line-height: 1.6;">
            <div><strong>üìÖ Data:</strong> ${poste.dataLancamento || "-"}</div>
            <div><strong>üèóÔ∏è Estrutura:</strong> ${poste.estruturaPrimaria || "-"}</div>
            <div><strong>‚ö° Linha Viva:</strong> ${poste.linhaViva ? "Sim" : "N√£o"}</div>
            <div><strong>üåø Podas:</strong> ${poste.servicosPodas ? "Sim" : "N√£o"}</div>
            <div><strong>üü¢ Status:</strong> 
              <span style="color: ${status === "conclu√≠do" ? "#4CAF50" : "#FF9800"}; font-weight: bold;">
                ${poste.status || "Em andamento"}
              </span>
            </div>
            <div><strong>‚è±Ô∏è Tempo:</strong> ${tempo}</div>
            <div><strong>üó∫Ô∏è Munic√≠pio:</strong> ${muni}</div>
            <div><strong>üë§ Usu√°rio:</strong> ${poste.usuario || "-"}</div>
          </div>
          ${(poste.foto1 || poste.foto2 || poste.foto3) ? `
            <div style="margin-top: 12px; border-top: 1px solid #eee; padding-top: 12px;">
              <button onclick="window.open('', '_blank').document.write('<html><body style=\\'padding:20px;text-align:center;\\'><img src=\\'${poste.foto1 || ''}\\' style=\\'max-width:90%;border-radius:8px;margin:10px\\'><br><img src=\\'${poste.foto2 || ''}\\' style=\\'max-width:90%;border-radius:8px;margin:10px\\'><br><img src=\\'${poste.foto3 || ''}\\' style=\\'max-width:90%;border-radius:8px;margin:10px\\'></body></html>')" 
                style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 12px; font-weight: 600;">
                üîç Ver Fotos
              </button>
            </div>
          ` : ""}
        </div>
      `;
    }

    async function buscarMunicipioAsync(id, lat, lng) {
      if (cachedMunicipalities.has(id)) return;
      
      try {
        const result = await geocoder.geocode({ location: { lat, lng } });
        if (result.results && result.results.length > 0) {
          for (const res of result.results) {
            const comp = res.address_components.find(c =>
              c.types.includes("administrative_area_level_2") || 
              c.types.includes("locality")
            );
            if (comp) {
              cachedMunicipalities.set(id, comp.long_name);
              if (infoWindows.has(id)) {
                const infoWindow = infoWindows.get(id);
                if (infoWindow.getMap()) {
                  const markerData = markers.get(id);
                  infoWindow.setContent(criarConteudoInfoWindow(markerData.data));
                }
              }
              break;
            }
          }
        }
      } catch (error) {
        cachedMunicipalities.set(id, "N√£o dispon√≠vel");
      }
    }

    // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
    function fazerLogin() {
      const email = document.getElementById("loginEmail").value.trim();
      const senha = document.getElementById("loginSenha").value.trim();
      
      if (!email || !senha) {
        document.getElementById("loginErro").innerText = "Por favor, preencha e-mail e senha.";
        return;
      }
      
      auth.signInWithEmailAndPassword(email, senha)
        .then((userCredential) => {
          userEmail = userCredential.user.email;
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("sistemaContainer").style.display = "block";
          carregarPostes();
        })
        .catch(err => {
          document.getElementById("loginErro").innerText = `Erro: ${err.message}`;
        });
    }

    function fazerLogout() {
      if (confirm("Voc√™ tem certeza que deseja sair do sistema Atbuilt?")) {
        auth.signOut()
          .then(() => {
            document.getElementById("sistemaContainer").style.display = "none";
            document.getElementById("loginContainer").style.display = "flex";
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginSenha").value = "";
            document.getElementById("loginErro").innerText = "";
            limparMapaCompletamente();
            mapaInicializado = false;
            todosOsPostes = [];
          })
          .catch(err => {
            alert(`‚ùå Falha ao sair: ${err.message}`);
          });
      }
    }

    // Verificar autentica√ß√£o ao carregar
    auth.onAuthStateChanged((user) => {
      if (user) {
        userEmail = user.email;
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("sistemaContainer").style.display = "block";
        carregarPostes();
      }
    });

    // ========== CALCULAR TEMPO DECORRIDO ==========
    function calcularTempoDecorrido(dataLancStr) {
      if (!dataLancStr) return null;
      const partes = dataLancStr.split(/[\s/:]+/).map(Number);
      const dataLanc = new Date(partes[2], partes[1] - 1, partes[0], partes[3], partes[4], partes[5] || 0);
      const agora = new Date();
      const diffMs = agora - dataLanc;
      if (isNaN(diffMs) || diffMs < 0) return null;
      const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      return { dias, horas };
    }

    // ========== CARREGAR POSTES ==========
    function carregarPostes() {
      db.ref("postes").on("value", snapshot => {
        const obj = snapshot.val() || {};
        const lista = Object.entries(obj)
          .filter(([, v]) => v !== null)
          .map(([id, data]) => {
            if (data.dataLancamento && typeof data.dataLancamento === "string") {
              const partes = data.dataLancamento.split(/[\s/:]+/).map(Number);
              if (partes.length >= 5) {
                data._dataConvertida = new Date(partes[2], partes[1]-1, partes[0], partes[3], partes[4], partes[5]||0);
              } else {
                data._dataConvertida = null;
              }
            }
            return { id, ...data };
          });
        
        lista.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));
        todosOsPostes = lista;
        paginaAtual = 1;
        filtrarPostes();
      });
    }

    // ========== NORMALIZA√á√ÉO DE TEXTO ==========
    function normalizarTexto(txt) {
      return (txt || "").toString().trim().toLowerCase();
    }

    // ========== FILTRAR POSTES ==========
    function filtrarPostes() {
      const filtroProjeto = normalizarTexto(document.getElementById("filtroProjeto")?.value);
      const filtroPoste ¬† = normalizarTexto(document.getElementById("filtroPoste")?.value);
      const filtroUsuario = normalizarTexto(document.getElementById("usuario")?.value);
      const filtroStatus ¬†= normalizarTexto(document.getElementById("filtroStatus")?.value);
      const dataInicial ¬† = document.getElementById("dataInicial").value;
      const dataFinal ¬† ¬† = document.getElementById("dataFinal").value;

      // filtrar
      listaFiltrada = todosOsPostes.filter(p => {
        const data = p._dataConvertida;
        const okProjeto = !filtroProjeto ||
                          normalizarTexto(p.idProjeto).includes(filtroProjeto);
        const okPoste ¬† = !filtroPoste ||
                          normalizarTexto(p.codigoPoste).includes(filtroPoste);
        const okUsuario = !filtroUsuario ||
                          normalizarTexto(p.usuario).includes(filtroUsuario);
        const statusNorm = normalizarTexto(p.status);
        const okStatus = !filtroStatus ||
        (filtroStatus === "em andamento"
        ? (statusNorm === "" || statusNorm === "em andamento")
        : statusNorm === filtroStatus);

        let okData = true;
        if (dataInicial) {
          const dtIni = new Date(`${dataInicial}T00:00:00`);
          okData = data instanceof Date && data >= dtIni;
        }
        if (okData && dataFinal) {
          const dtFim = new Date(`${dataFinal}T23:59:59`);
          okData = data instanceof Date && data <= dtFim;
        }
        return okProjeto && okPoste && okUsuario && okStatus && okData;
      });

      // Aplicar filtros especiais
      if (mostrandoSomentePodas) {
        listaFiltrada = listaFiltrada.filter(p => {
          const podas = (p.servicosPodas || "").trim().toLowerCase();
          const status = (p.status || "").trim().toLowerCase();
          return podas && podas !== "n√£o recebido" && status !== "conclu√≠do";
        });
      }
      
      if (mostrandoSomenteLinhaViva) {
        listaFiltrada = listaFiltrada.filter(p => {
          const lv = (p.linhaViva || "").trim().toLowerCase();
          const st = (p.status ¬† || "").trim().toLowerCase();
          const invalido = !lv || lv === "selecione os servi√ßos" || lv === "n√£o recebido";
          return !invalido && st !== "conclu√≠do";
        });
      }

      // calcular tempo decorrido
      listaFiltrada.forEach(p => {
        if ((p.status || "").toLowerCase() === "em andamento") {
          p.tempoDecorrido = calcularTempoDecorrido(p.dataLancamento || "");
        } else {
          p.tempoDecorrido = null;
        }
      });

      // ordenar
      listaFiltrada.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

      // paginar
      const totalPaginas = Math.ceil(listaFiltrada.length / itensPorPagina);
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim ¬† ¬†= inicio + itensPorPagina;
      listaVisivel = listaFiltrada.slice(inicio, fim);

      exibirPostes(listaVisivel);
      mostrarMapaOtimizado(listaVisivel);
      atualizarPaginacao(totalPaginas);
      atualizarContadorStatus();
      atualizarContadorRegistros();
    }

    // ========== ATUALIZAR PAGINA√á√ÉO ==========
    function atualizarPaginacao(totalPaginas) {
      const pagDiv = document.getElementById("paginacao");
      pagDiv.innerHTML = "";

      if (totalPaginas <= 1) {
        return;
      }

      // Informa√ß√£o da p√°gina
      const spanStatus = document.createElement("span");
      spanStatus.textContent = `P√°gina ${paginaAtual} de ${totalPaginas}`;
      spanStatus.style.margin = "0 10px";
      spanStatus.style.fontWeight = "bold";
      pagDiv.appendChild(spanStatus);
      
      // Bot√£o Anterior
      const btnAnterior = document.createElement("button");
      btnAnterior.textContent = "¬´ Anterior";
      btnAnterior.disabled = paginaAtual === 1;
      btnAnterior.onclick = () => {
        paginaAtual = Math.max(1, paginaAtual - 1);
        filtrarPostes();
      };
      pagDiv.appendChild(btnAnterior);
      
      // Bot√£o Pr√≥xima
      const btnProxima = document.createElement("button");
      btnProxima.textContent = "Pr√≥xima ¬ª";
      btnProxima.disabled = paginaAtual === totalPaginas;
      btnProxima.onclick = () => {
        paginaAtual = Math.min(totalPaginas, paginaAtual + 1);
        filtrarPostes();
      };
      pagDiv.appendChild(btnProxima);
    }

    // ========== EXIBIR POSTES ==========
    function exibirPostes(lista) {
      const tbody = document.querySelector("#tabelaPostes tbody");
      tbody.innerHTML = "";

      lista.forEach(p => {
        const status = normalizarTexto(p.status || "em andamento");
        const tempo = p.tempoDecorrido
          ? `${p.tempoDecorrido.dias}d ${p.tempoDecorrido.horas}h`
          : "-";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.dataLancamento || ""}</td>
          <td><input type="text" value="${p.idProjeto||""}" disabled></td>
          <td><input type="text" value="${p.codigoPoste||""}" disabled></td>
          <td><input type="text" value="${p.postePrimario||""}" disabled></td>
          <td><input type="text" value="${p.estruturaPrimaria||""}" disabled></td>
          <td><input type="text" value="${p.posteSecundario||""}" disabled></td>
          <td><input type="text" value="${p.estruturaSecundaria||""}" disabled></td>
          <td><textarea disabled>${p.linhaViva||""}</textarea></td>
          <td><textarea disabled>${p.servicosPodas||""}</textarea></td>
          <td><textarea disabled>${p.observacoes||""}</textarea></td>
          <td><input type="text" value="${p.latitude||""}" readonly></td>
          <td><input type="text" value="${p.longitude||""}" readonly></td>
          <td><input type="text" value="${p.usuario||""}" readonly></td>
          <td>
            <span class="status-badge ${status === "conclu√≠do" ? "status-concluido" : "status-andamento"}">
              ${p.status || "Em andamento"}
            </span>
          </td>
          <td>${tempo}</td>
          <td><button class="btn-edit" onclick="editar(this)">‚úèÔ∏è Editar</button></td>
          <td><button class="delete-btn" onclick="excluir(this)">üóëÔ∏è</button></td>
        `;
        tr.dataset.id = p.id;
        tbody.appendChild(tr);
      });
    }

    // ========== ATUALIZAR CONTADOR DE STATUS ==========
    function atualizarContadorStatus() {
      const lista = todosOsPostes;

      const totalProj ¬† = new Set(lista.map(p => (p.idProjeto || "").trim()).filter(x => x !== "")).size;
      const totalPostes = lista.length;
      const concluidos ¬†= lista.filter(p => normalizarTexto(p.status) === "conclu√≠do").length;
      const andamento ¬† = lista.filter(p => {
        const s = normalizarTexto(p.status);
        return s === "" || s === "em andamento";
      }).length;

      const regexValor = /r\$ ?[\d.,]+/i;

      // --- CORRE√á√ÉO: ADICIONADO .length ---
      const comPodas = lista.filter(p => {
        const txt = (p.servicosPodas || "").toLowerCase().replace(/\n/g, " ");
        return regexValor.test(txt);
      }).length;

      const podasPend = lista.filter(p => {
        const txt = (p.servicosPodas || "").toLowerCase().replace(/\n/g, " ");
        const status = normalizarTexto(p.status);
        return regexValor.test(txt) && status !== "conclu√≠do";
      }).length;

      const comLV = lista.filter(p => {
        const txt = (p.linhaViva || "").toLowerCase().replace(/\n/g, " ");
        return regexValor.test(txt);
      }).length;

      const lvPend = lista.filter(p => {
        const txt = (p.linhaViva || "").toLowerCase().replace(/\n/g, " ");
        const status = normalizarTexto(p.status);
        return regexValor.test(txt) && status !== "conclu√≠do";
      }).length;
      // ------------------------------------

      const totalPodas = somarValor("servicosPodas", "status", lista);
      const totalLV = somarValor("linhaViva", "status", lista);

      const totalPodasf = totalPodas > 0 ? totalPodas.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }) : null;
      const totalLVf ¬† ¬†= totalLV > 0 ? totalLV.toLocaleString("pt-BR", { style: "currency", currency: "BRL" }) : null;

      const agora = new Date();
      const horaAtual = agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      const dataAtual = agora.toLocaleDateString("pt-BR");

      let msg =
        `üìö ${totalProj} projetos | üî¢ ${totalPostes} postes | ‚úÖ ${concluidos} conclu√≠dos | ` +
        `üõ† ${andamento} em andamento | üåø ${comPodas} com poda | üï≥Ô∏è ${podasPend} podas pendentes | ` +
        `‚ö° ${comLV} com linha viva | ‚è≥ ${lvPend} linha viva pendente`;

      if (totalPodasf) msg += ` | üí∞ Total Podas: ${totalPodasf}`;
      if (totalLVf) ¬† ¬†msg += ` | üí∞ Total LV: ${totalLVf}`;

      msg += ` | üïí Atualizado em: ${dataAtual} √†s ${horaAtual}`;

      document.getElementById("contadorStatus").innerText = msg;
    }
    
    function atualizarContadorRegistros() {
      // Fun√ß√£o placeholder caso precise exibir contador na UI
    }

    function somarValor(labelField, statusField, lista) {
      let total = 0;
      lista.forEach(p => {
        const textoOriginal = (p[labelField] || "").trim().toLowerCase();
        const stat = (p[statusField] || "").trim().toLowerCase();

        const textoLimpo = textoOriginal.replace(/\s+/g, " ").replace(/\n/g, " ").trim();

        if (
          !textoLimpo || 
          textoLimpo === "n√£o recebido" || 
          textoLimpo === "selecione os servi√ßos" || 
          stat === "conclu√≠do"
        ) return;

        const matches = textoLimpo.match(/r\$ ?[\d.,]+/gi);
        if (matches) {
          matches.forEach(val => {
            const num = parseFloat(val.replace(/[^\d,]/g, "").replace(",", ".")) || 0;
            total += num;
          });
        }
      });
      return total;
    }

    // ========== EDI√á√ÉO E EXCLUS√ÉO ==========
    function editar(botao) {
      const tr = botao.closest("tr");
      const estaEditando = botao.textContent === "Salvar";
      
      if (estaEditando) {
        salvar(tr);
        botao.textContent = "‚úèÔ∏è Editar";
        botao.className = "btn-edit";
        
        const campos = tr.querySelectorAll("input, textarea, select");
        campos.forEach(el => {
          if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
            el.disabled = true;
          } else {
            el.disabled = true;
          }
        });
      } else {
        botao.textContent = "Salvar";
        botao.className = "btn-success";
        
        const campos = tr.querySelectorAll("input, textarea, select");
        campos.forEach(el => {
          const td = el.closest("td");
          if (!td) return;
          const colIndex = Array.from(tr.children).indexOf(td);
          const bloqueadas = [0, 10, 11, 12]; // Data, Lat, Lng, Usu√°rio
          if (!bloqueadas.includes(colIndex)) {
            el.disabled = false;
          }
        });
      }
    }

    async function salvar(tr) {
      const btnSalvar = tr.querySelector("button");
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="loading"></span> Salvando...';

      const id ¬† ¬† ¬† ¬† ¬† ¬†= tr.dataset.id;
      const idProj ¬† ¬† ¬† ¬†= tr.children[1].querySelector("input").value.trim() || "";
      const codPoste ¬† ¬† ¬†= tr.children[2].querySelector("input").value.trim() || "";
      const postePrimario = tr.children[3].querySelector("input").value.trim() || "";
      const estrPrimaria ¬†= tr.children[4].querySelector("input").value.trim() || "";
      const posteSec ¬† ¬† ¬†= tr.children[5].querySelector("input").value.trim() || "";
      const estrSecund ¬† ¬†= tr.children[6].querySelector("input").value.trim() || "";
      const linhaViva ¬† ¬† = tr.children[7].querySelector("textarea").value.trim() || "";
      const servPodas ¬† ¬† = tr.children[8].querySelector("textarea").value.trim() || "";
      const obs ¬† ¬† ¬† ¬† ¬† = tr.children[9].querySelector("textarea").value.trim() || "";
      const lat ¬† ¬† ¬† ¬† ¬† = tr.children[10].querySelector("input").value.trim() || "";
      const lng ¬† ¬† ¬† ¬† ¬† = tr.children[11].querySelector("input").value.trim() || "";
      const usuario ¬† ¬† ¬† = tr.children[12].querySelector("input").value.trim() || "";
      const status ¬† ¬† ¬† ¬†= tr.children[13].querySelector(".status-badge").textContent.trim();

      try {
        await db.ref(`postes/${id}`).update({
          idProjeto: ¬† ¬† ¬†idProj,
          codigoPoste: ¬† ¬†codPoste,
          postePrimario,
          estruturaPrimaria: ¬† estrPrimaria,
          posteSecundario: ¬† ¬† posteSec,
          estruturaSecundaria: estrSecund,
          linhaViva,
          servicosPodas: servPodas,
          observacoes: ¬† obs,
          latitude: ¬† ¬† ¬†lat,
          longitude: ¬† ¬† lng,
          usuario,
          status
        });
        
        // Feedback visual
        btnSalvar.textContent = "‚úì Salvo!";
        setTimeout(() => {
          btnSalvar.textContent = "‚úèÔ∏è Editar";
          btnSalvar.className = "btn-edit";
          btnSalvar.disabled = false;
          filtrarPostes();
        }, 1000);
        
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao salvar: ${err.message}`);
        btnSalvar.textContent = "‚úèÔ∏è Editar";
        btnSalvar.className = "btn-edit";
        btnSalvar.disabled = false;
      }
    }

    async function excluir(botao) {
      const tr = botao.closest("tr");
      const id = tr.dataset.id;
      if (!confirm("Deseja realmente excluir este poste?")) return;
      botao.disabled = true;
      botao.innerHTML = '<span class="loading"></span>';
      try {
        await db.ref(`postes/${id}`).remove();
        tr.style.opacity = "0.5";
        setTimeout(() => {
          filtrarPostes();
        }, 300);
      } catch (err) {
        console.error(err);
        alert(`‚ùå Falha ao excluir: ${err.message}`);
        botao.disabled = false;
        botao.textContent = "üóëÔ∏è";
      }
    }

    // ========== FUN√á√ïES ESPECIAIS ==========
    function togglePodas() {
      mostrandoSomentePodas = !mostrandoSomentePodas;
      const botao = document.getElementById("btnMostrarPodas");
      
      if (mostrandoSomentePodas) {
        botao.textContent = "üåø Mostrar Todos";
        botao.classList.add("success");
      } else {
        botao.textContent = "üåø Mostrar Podas";
        botao.classList.remove("success");
      }
      
      filtrarPostes();
    }

    function toggleLinhaViva() {
      mostrandoSomenteLinhaViva = !mostrandoSomenteLinhaViva;
      const botao = document.getElementById("btnMostrarLinhaViva");
      
      if (mostrandoSomenteLinhaViva) {
        botao.textContent = "‚ö° Mostrar Todos";
        botao.classList.add("success");
      } else {
        botao.textContent = "‚ö° Mostrar Linha Viva";
        botao.classList.remove("success");
      }
      
      filtrarPostes();
    }

    function togglePowerBI() {
      const mainContent = document.querySelector(".sistema-container > :not(#powerbiContainer)");
      const powerBI = document.getElementById("powerbiContainer");
      
      if (powerBI.style.display === "none" || !powerBI.style.display) {
        mainContent.style.display = "none";
        powerBI.style.display = "block";
      } else {
        powerBI.style.display = "none";
        mainContent.style.display = "block";
      }
    }

    async function verificarDuplicados() {
      const mapa = new Map();
      const duplicados = [];

      // Identificar duplicados
      todosOsPostes.forEach(poste => {
        const chave = `${normalizarTexto(poste.idProjeto)}|${normalizarTexto(poste.codigoPoste)}`;
        if (mapa.has(chave)) {
          duplicados.push(poste);
        } else {
          mapa.set(chave, poste.id);
        }
      });

      if (duplicados.length === 0) {
        alert("‚úÖ Nenhum registro duplicado encontrado.");
        return;
      }

      // Destacar duplicados
      document.querySelectorAll("#tabelaPostes tbody tr").forEach(tr => {
        tr.style.backgroundColor = "";
      });

      duplicados.forEach(poste => {
        const tr = document.querySelector(`tr[data-id="${poste.id}"]`);
        if (tr) {
          tr.style.backgroundColor = "rgba(255, 152, 0, 0.1)";
        }
      });

      const confirmar = confirm(
        `Foram encontrados ${duplicados.length} registros duplicados.\n\n` +
        'Deseja excluir automaticamente os registros mais antigos?'
      );

      if (!confirmar) return;

      // Excluir duplicados
      for (const poste of duplicados) {
        try {
          await db.ref(`postes/${poste.id}`).remove();
        } catch (error) {
          console.error("Erro ao excluir duplicado:", error);
        }
      }

      alert(`‚úÖ ${duplicados.length} registros duplicados foram removidos.`);
      carregarPostes();
    }

    // ========== EXPORTA√á√ÉO CSV ==========
    function exportarCSV(tudo) {
      const dados = tudo ? listaFiltrada : listaVisivel;
      
      if (dados.length === 0) {
        alert("Nenhum dado para exportar.");
        return;
      }
      
      // Cabe√ßalhos
      const cabecalhos = [
        'Data', 'ID Projeto', 'PG', 'Poste Prim√°rio', 'Estrutura Prim√°ria',
        'Poste Secund√°rio', 'Estrutura Secund√°ria', 'Linha Viva', 'Servi√ßos Podas',
        'Observa√ß√µes', 'Latitude', 'Longitude', 'Usu√°rio', 'Status', 'Tempo Decorrido'
      ];
      
      // Linhas
      const linhas = dados.map(poste => {
        const tempo = poste.tempoDecorrido ? 
          `${poste.tempoDecorrido.dias}d ${poste.tempoDecorrido.horas}h` : "";
        
        return [
          `"${poste.dataLancamento || ''}"`,
          `"${poste.idProjeto || ''}"`,
          `"${poste.codigoPoste || ''}"`,
          `"${poste.postePrimario || ''}"`,
          `"${poste.estruturaPrimaria || ''}"`,
          `"${poste.posteSecundario || ''}"`,
          `"${poste.estruturaSecundaria || ''}"`,
          `"${poste.linhaViva || ''}"`,
          `"${poste.servicosPodas || ''}"`,
          `"${poste.observacoes || ''}"`,
          `"${poste.latitude || ''}"`,
          `"${poste.longitude || ''}"`,
          `"${poste.usuario || ''}"`,
          `"${poste.status || ''}"`,
          `"${tempo}"`
        ].join(',');
      });
      
      // Criar CSV
      const conteudo = [cabecalhos.join(','), ...linhas].join('\n');
      const blob = new Blob(['\uFEFF' + conteudo], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `postes_${tudo ? 'completo' : 'pagina_${paginaAtual}'}_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }
  
    function baixarPDFModelo() {
      alert("Funcionalidade de PDF em desenvolvimento. Use a exporta√ß√£o CSV por enquanto.");
    }
  </script>
</body>
</html>




